name: Build Static PHP for Android - Full Features

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      php_version:
        description: 'PHPç‰ˆæœ¬'
        required: true
        default: '8.3.4'
      min_sdk:
        description: 'æœ€ä½ŽAndroid SDKç‰ˆæœ¬'
        required: false
        default: '24'

env:
  NDK_VERSION: 'r26c'
  PHP_VERSION: '8.3.4'

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        arch: [arm64-v8a, armeabi-v7a, x86_64]
        include:
          - arch: arm64-v8a
            host: aarch64-linux-android
            triple: aarch64-linux-android
            abi: aarch64-linux-android
            target: aarch64-linux-android
          - arch: armeabi-v7a
            host: armv7a-linux-androideabi
            triple: arm-linux-androideabi
            abi: arm-linux-androideabi
            target: armv7a-linux-androideabi
          - arch: x86_64
            host: x86_64-linux-android
            triple: x86_64-linux-android
            abi: x86_64-linux-android
            target: x86_64-linux-android
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-android-ndk
      with:
        ndk-version: ${{ env.NDK_VERSION }}
        add-to-path: false

    - name: é…ç½®çŽ¯å¢ƒå˜é‡
      run: |
        NDK_ROOT="${{ steps.setup-android-ndk.outputs.ndk-path }}"
        echo "NDK_ROOT=$NDK_ROOT" >> $GITHUB_ENV
        
        TOOLCHAIN="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64"
        echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
        
        API_LEVEL=${{ github.event.inputs.min_sdk || '24' }}
        echo "API_LEVEL=$API_LEVEL" >> $GITHUB_ENV
        
        # è®¾ç½®ç¼–è¯‘å™¨è·¯å¾„
        echo "CC=$TOOLCHAIN/bin/${matrix.host}$API_LEVEL-clang" >> $GITHUB_ENV
        echo "CXX=$TOOLCHAIN/bin/${matrix.host}$API_LEVEL-clang++" >> $GITHUB_ENV
        echo "AR=$TOOLCHAIN/bin/llvm-ar" >> $GITHUB_ENV
        echo "RANLIB=$TOOLCHAIN/bin/llvm-ranlib" >> $GITHUB_ENV
        echo "STRIP=$TOOLCHAIN/bin/llvm-strip" >> $GITHUB_ENV
        echo "LD=$TOOLCHAIN/bin/ld" >> $GITHUB_ENV

    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget tar xz-utils curl \
          build-essential \
          autoconf automake libtool \
          pkg-config bison re2c \
          cmake ninja-build \
          git unzip \
          libxml2-dev libssl-dev libcurl4-openssl-dev \
          libsqlite3-dev libonig-dev \
          libzip-dev libpng-dev libjpeg-dev \
          libfreetype6-dev libwebp-dev \
          libbz2-dev libgmp-dev libicu-dev \
          libsodium-dev libargon2-dev \
          libxslt-dev libexpat1-dev \
          libpq-dev libpq5 \
          libgd-dev libtidy-dev \
          libyaml-dev libedit-dev \
          libffi-dev libc-client-dev \
          libkrb5-dev libsasl2-dev \
          libldap2-dev \
          libpcre2-dev \
          libxmlrpc-epi-dev \
          libenchant-2-dev \
          libpspell-dev \
          libsnmp-dev \
          libmemcached-dev \
          librabbitmq-dev \
          libgearman-dev \
          libevent-dev \
          libmaxminddb-dev \
          libmongoc-dev \
          libbson-dev \
          upx

    - name: ä¸‹è½½ PHP æºç 
      run: |
        PHP_VERSION=${{ github.event.inputs.php_version || env.PHP_VERSION }}
        echo "ä¸‹è½½ PHP $PHP_VERSION..."
        
        # ä½¿ç”¨ PHP å®˜æ–¹é•œåƒ
        wget -q --timeout=30 --tries=3 \
          "https://www.php.net/distributions/php-$PHP_VERSION.tar.xz" \
          -O "php-$PHP_VERSION.tar.xz"
        
        if [ ! -f "php-$PHP_VERSION.tar.xz" ]; then
          echo "å°è¯•å¤‡ç”¨ä¸‹è½½æº..."
          wget -q "https://mirrors.aliyun.com/php-distributions/php-$PHP_VERSION.tar.xz"
        fi
        
        tar -xf "php-$PHP_VERSION.tar.xz"
        echo "PHP_SOURCE_DIR=$(pwd)/php-$PHP_VERSION" >> $GITHUB_ENV

    - name: ç¼–è¯‘ä¾èµ–åº“
      run: |
        cd "$PHP_SOURCE_DIR"
        mkdir -p build-deps && cd build-deps
        
        # å®šä¹‰ä¾èµ–åº“åˆ—è¡¨
        DEPS=(
          "https://www.zlib.net/zlib-1.3.tar.gz"
          "https://github.com/openssl/openssl/releases/download/openssl-3.1.4/openssl-3.1.4.tar.gz"
          "https://curl.se/download/curl-8.5.0.tar.xz"
          "https://sqlite.org/2023/sqlite-autoconf-3440200.tar.gz"
          "https://github.com/jedisct1/libsodium/releases/download/1.0.19/libsodium-1.0.19.tar.gz"
          "https://github.com/facebook/zstd/releases/download/v1.5.5/zstd-1.5.5.tar.gz"
          "https://github.com/libzip/libzip/releases/download/v1.10.1/libzip-1.10.1.tar.xz"
          "https://sourceware.org/pub/bzip2/bzip2-1.0.8.tar.gz"
          "https://gmplib.org/download/gmp/gmp-6.3.0.tar.xz"
          "https://github.com/unicode-org/icu/releases/download/release-73-2/icu4c-73_2-src.tgz"
          "https://www.libpng.org/pub/png/libpng-1.6.40.tar.xz"
          "https://download.sourceforge.net/libjpeg-turbo/libjpeg-turbo-3.0.1.tar.gz"
          "https://downloads.sourceforge.net/freetype/freetype-2.13.2.tar.xz"
          "https://github.com/webmproject/libwebp/archive/refs/tags/v1.3.2.tar.gz"
          "https://www.gnupg.org/ftp/gcrypt/libgpg-error/libgpg-error-1.47.tar.bz2"
          "https://www.gnupg.org/ftp/gcrypt/libgcrypt/libgcrypt-1.10.3.tar.bz2"
          "https://github.com/nghttp2/nghttp2/releases/download/v1.57.0/nghttp2-1.57.0.tar.xz"
          "https://github.com/libssh2/libssh2/releases/download/libssh2-1.11.0/libssh2-1.11.0.tar.gz"
          "https://github.com/Kitware/CMake/releases/download/v3.28.1/cmake-3.28.1.tar.gz"
        )
        
        # ç¼–è¯‘å‡½æ•°
        compile_dep() {
          local url="$1"
          local file=$(basename "$url")
          echo "ç¼–è¯‘ $file..."
          
          wget -q "$url" || return 1
          
          case "$file" in
            *.tar.gz) tar -xzf "$file" ;;
            *.tar.xz) tar -xf "$file" ;;
            *.tar.bz2) tar -xjf "$file" ;;
            *.tgz) tar -xzf "$file" ;;
          esac
          
          local dir=$(tar -tf "$file" | head -1 | cut -f1 -d"/")
          cd "$dir"
          
          # é…ç½®çŽ¯å¢ƒ
          export CC="$CC"
          export CXX="$CXX"
          export AR="$AR"
          export RANLIB="$RANLIB"
          export STRIP="$STRIP"
          export LD="$LD"
          
          # é€šç”¨çš„é…ç½®é€‰é¡¹
          local configure_cmd="./configure"
          case "$dir" in
            openssl-*)
              ./Configure android-${{ matrix.arch }} \
                -D__ANDROID_API__=$API_LEVEL \
                --prefix="$TOOLCHAIN/sysroot/usr" \
                --cross-compile-prefix="$TOOLCHAIN/bin/${matrix.host}$API_LEVEL-" \
                no-shared no-dso no-engine no-hw no-asm
              ;;
            bzip2-*)
              make -f Makefile-libbz2_so
              make install PREFIX="$TOOLCHAIN/sysroot/usr"
              cd ..
              return 0
              ;;
            libpng-*|freetype-*|libjpeg-turbo-*|libwebp-*)
              "$configure_cmd" \
                --host=${{ matrix.host }} \
                --prefix="$TOOLCHAIN/sysroot/usr" \
                --disable-shared \
                --enable-static \
                --with-pic
              ;;
            *)
              "$configure_cmd" \
                --host=${{ matrix.host }} \
                --prefix="$TOOLCHAIN/sysroot/usr" \
                --disable-shared \
                --enable-static \
                --with-pic \
                --disable-dependency-tracking
              ;;
          esac
          
          make -j$(nproc)
          make install
          cd ..
        }
        
        # ç¼–è¯‘æ‰€æœ‰ä¾èµ–
        for dep_url in "${DEPS[@]}"; do
          compile_dep "$dep_url" || echo "è­¦å‘Š: $dep_url ç¼–è¯‘å¤±è´¥ï¼Œç»§ç»­..."
        done

    - name: é…ç½® PHPï¼ˆæœ€å¤§åŒ–é…ç½®ï¼‰
      run: |
        cd "$PHP_SOURCE_DIR"
        
        # æ¸…ç†å¹¶åˆ›å»ºæž„å»ºç›®å½•
        rm -rf build-android
        mkdir build-android && cd build-android
        
        # è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒ
        export CC="$CC"
        export CXX="$CXX"
        export AR="$AR"
        export RANLIB="$RANLIB"
        export STRIP="$STRIP"
        export LD="$LD"
        
        # ä¼˜åŒ–ç¼–è¯‘æ ‡å¿—
        export CFLAGS="-fPIE -fPIC -Os -flto -D__ANDROID_API__=$API_LEVEL -I$TOOLCHAIN/sysroot/usr/include"
        export CXXFLAGS="$CFLAGS"
        export LDFLAGS="-static -flto -pie -Wl,--gc-sections -Wl,-s -L$TOOLCHAIN/sysroot/usr/lib"
        export LIBS="-ldl -lm -llog -lz"
        
        # åˆ›å»º sysroot ç›®å½•
        mkdir -p "$TOOLCHAIN/sysroot/usr/include/php"
        mkdir -p "$TOOLCHAIN/sysroot/usr/lib/php"
        
        # PHP é…ç½® - å¼€å¯æ‰€æœ‰å¯èƒ½çš„æ¨¡å—ï¼Œä»…å…³é—­ Android ä¸æ”¯æŒçš„
        ../configure \
          --host=${{ matrix.host }} \
          --target=${{ matrix.target }} \
          --prefix=/data/local/tmp/php \
          --enable-cli \
          --disable-cgi \
          --disable-fpm \
          --with-pear=no \
          --enable-static=yes \
          --disable-shared \
          --with-openssl="$TOOLCHAIN/sysroot/usr" \
          --with-curl="$TOOLCHAIN/sysroot/usr" \
          --with-zlib="$TOOLCHAIN/sysroot/usr" \
          --with-bz2="$TOOLCHAIN/sysroot/usr" \
          --with-gmp="$TOOLCHAIN/sysroot/usr" \
          --with-iconv \
          --with-mhash \
          --with-pcre-jit \
          --with-pcre-regex \
          --with-pdo-sqlite="$TOOLCHAIN/sysroot/usr" \
          --with-sqlite3="$TOOLCHAIN/sysroot/usr" \
          --with-zip="$TOOLCHAIN/sysroot/usr" \
          --with-mysqli=mysqlnd \
          --with-pdo-mysql=mysqlnd \
          --with-pdo-pgsql="$TOOLCHAIN/sysroot/usr" \
          --with-pgsql="$TOOLCHAIN/sysroot/usr" \
          --with-gd \
          --with-webp \
          --with-jpeg \
          --with-png \
          --with-freetype \
          --with-xmlrpc \
          --with-xsl \
          --with-tidy="$TOOLCHAIN/sysroot/usr" \
          --with-expat \
          --with-gettext \
          --with-ldap \
          --with-kerberos \
          --with-imap-ssl \
          --with-snmp \
          --with-pspell \
          --with-enchant \
          --with-sodium="$TOOLCHAIN/sysroot/usr" \
          --with-libedit \
          --with-readline \
          --with-ffi \
          --enable-bcmath \
          --enable-calendar \
          --enable-dba=shared \
          --enable-exif \
          --enable-ftp \
          --enable-gd-jis-conv \
          --enable-intl \
          --enable-mbstring \
          --enable-phar \
          --enable-posix \
          --enable-shmop \
          --enable-sockets \
          --enable-sysvmsg \
          --enable-sysvsem \
          --enable-sysvshm \
          --enable-wddx \
          --enable-zip \
          --with-zlib-dir="$TOOLCHAIN/sysroot/usr" \
          --with-password-argon2 \
          --with-sodium \
          --enable-pcntl \
          --enable-simplexml \
          --enable-xml \
          --enable-xmlreader \
          --enable-xmlwriter \
          --enable-dom \
          --enable-filter \
          --enable-hash \
          --enable-json \
          --enable-libxml \
          --enable-opcache \
          --enable-opcache-file \
          --enable-fileinfo \
          --enable-tokenizer \
          --enable-session \
          --enable-ctype \
          --enable-iconv \
          --enable-simplexml \
          --enable-soap \
          --enable-shmop \
          --enable-sysvsem \
          --enable-sysvshm \
          --enable-sysvmsg \
          --enable-wddx \
          --with-config-file-path=/data/local/tmp \
          --with-config-file-scan-dir=/data/local/tmp/php.d \
          # ä»…å…³é—­ Android ä¸æ”¯æŒçš„æ¨¡å—
          --disable-debug \
          --without-dbm \
          --without-ndbm \
          --without-gdbm \
          --without-qdbm \
          --without-lmdb \
          --without-libedit \
          --without-readline \
          --without-valgrind \
          CC="$CC" \
          CXX="$CXX" \
          AR="$AR" \
          RANLIB="$RANLIB" \
          STRIP="$STRIP"

    - name: ç¼–è¯‘ PHP
      run: |
        cd "$PHP_SOURCE_DIR/build-android"
        
        echo "å¼€å§‹ç¼–è¯‘ PHP..."
        make -j$(nproc) || make  # å¦‚æžœå¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ä¸²è¡Œ
        
        # ç¼–è¯‘ PECL æ‰©å±•
        echo "ç¼–è¯‘é¢å¤–æ‰©å±•..."
        make install-modules 2>/dev/null || true
        
        # éªŒè¯ç¼–è¯‘ç»“æžœ
        if [ -f "sapi/cli/php" ]; then
          echo "ç¼–è¯‘æˆåŠŸï¼"
          echo "æ–‡ä»¶ä¿¡æ¯ï¼š"
          file sapi/cli/php
          echo "åˆå§‹å¤§å°ï¼š"
          ls -lh sapi/cli/php
        else
          echo "ç¼–è¯‘å¤±è´¥ï¼"
          exit 1
        fi

    - name: ä¼˜åŒ–äºŒè¿›åˆ¶æ–‡ä»¶
      run: |
        cd "$PHP_SOURCE_DIR/build-android"
        
        # ç§»é™¤è°ƒè¯•ç¬¦å·
        $STRIP --strip-all sapi/cli/php
        
        # ä½¿ç”¨ UPX åŽ‹ç¼©ï¼ˆå¦‚æžœå¯ç”¨ï¼‰
        if command -v upx >/dev/null 2>&1; then
          echo "ä½¿ç”¨ UPX åŽ‹ç¼©..."
          upx --lzma --best sapi/cli/php 2>/dev/null || true
        fi
        
        echo "ä¼˜åŒ–åŽçš„æ–‡ä»¶ï¼š"
        ls -lh sapi/cli/php
        echo "æ–‡ä»¶ç±»åž‹ï¼š"
        file sapi/cli/php

    - name: æµ‹è¯• PHP åŠŸèƒ½
      run: |
        cd "$PHP_SOURCE_DIR/build-android"
        
        echo "=== PHP ç‰ˆæœ¬ä¿¡æ¯ ===" > php_info.txt
        ./sapi/cli/php -v >> php_info.txt 2>&1
        
        echo "" >> php_info.txt
        echo "=== å·²åŠ è½½çš„æ‰©å±• ===" >> php_info.txt
        ./sapi/cli/php -m >> php_info.txt 2>&1
        
        echo "" >> php_info.txt
        echo "=== é…ç½®ä¿¡æ¯ ===" >> php_info.txt
        ./sapi/cli/php -i | grep -E "(extension|module|support)" >> php_info.txt 2>&1
        
        echo "æµ‹è¯•å®Œæˆï¼Œç»“æžœä¿å­˜åˆ° php_info.txt"
        cat php_info.txt | head -50

    - name: åˆ›å»ºåˆ†å‘åŒ…
      run: |
        ARCH=${{ matrix.arch }}
        DIST_DIR="$GITHUB_WORKSPACE/dist/$ARCH"
        mkdir -p "$DIST_DIR"
        
        # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
        cp "$PHP_SOURCE_DIR/build-android/sapi/cli/php" "$DIST_DIR/php"
        
        # åˆ›å»ºå®Œæ•´çš„ php.ini é…ç½®æ–‡ä»¶
        cat > "$DIST_DIR/php.ini" << 'EOF'
        ; PHP é…ç½®æ–‡ä»¶ for Android
        ; æœ€å¤§åŒ–çš„åŠŸèƒ½é…ç½®
        
        engine = On
        short_open_tag = Off
        precision = 14
        output_buffering = 4096
        zlib.output_compression = Off
        implicit_flush = Off
        unserialize_callback_func =
        serialize_precision = -1
        
        ; ç¦ç”¨å±é™©å‡½æ•°
        disable_functions = dl,exec,passthru,shell_exec,system,proc_open,popen
        disable_classes =
        
        ; é”™è¯¯å¤„ç†
        error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT
        display_errors = Off
        display_startup_errors = Off
        log_errors = On
        error_log = /data/local/tmp/php_errors.log
        
        ; å†…å­˜é™åˆ¶
        memory_limit = 256M
        max_execution_time = 30
        max_input_time = 60
        
        ; æ‰©å±•ç›®å½•
        extension_dir = "./"
        
        ; å¯ç”¨å¸¸ç”¨æ‰©å±•
        extension=bcmath
        extension=bz2
        extension=calendar
        extension=exif
        extension=ffi
        extension=ftp
        extension=gd
        extension=gettext
        extension=gmp
        extension=iconv
        extension=intl
        extension=mbstring
        extension=openssl
        extension=pcntl
        extension=pdo
        extension=pdo_sqlite
        extension=phar
        extension=posix
        extension=shmop
        extension=soap
        extension=sockets
        extension=sodium
        extension=sqlite3
        extension=xmlrpc
        extension=xsl
        extension=zip
        
        ; ä¼šè¯é…ç½®
        session.save_handler = files
        session.save_path = "/data/local/tmp/sessions"
        session.use_strict_mode = 1
        session.cookie_secure = 1
        
        ; Opcache é…ç½®
        opcache.enable=1
        opcache.memory_consumption=128
        opcache.interned_strings_buffer=8
        opcache.max_accelerated_files=10000
        opcache.revalidate_freq=2
        opcache.fast_shutdown=1
        
        ; æ—¶åŒºè®¾ç½®
        date.timezone = Asia/Shanghai
        EOF
        
        # åˆ›å»ºå¢žå¼ºçš„å¯åŠ¨è„šæœ¬
        cat > "$DIST_DIR/php-wrapper" << 'EOF'
        #!/system/bin/sh
        # PHP for Android å¢žå¼ºå¯åŠ¨è„šæœ¬
        
        SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
        PHP_BIN="$SCRIPT_DIR/php"
        
        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        export TMPDIR="/data/local/tmp"
        export HOME="/data/local/tmp"
        export PHP_INI_SCAN_DIR="$SCRIPT_DIR"
        export LD_LIBRARY_PATH="$SCRIPT_DIR:\$LD_LIBRARY_PATH"
        
        # æ£€æŸ¥å¹¶åˆ›å»ºå¿…è¦ç›®å½•
        mkdir -p "$TMPDIR/sessions" 2>/dev/null
        mkdir -p "$TMPDIR/php" 2>/dev/null
        
        # ç¡®ä¿äºŒè¿›åˆ¶å¯æ‰§è¡Œ
        if [ ! -x "$PHP_BIN" ]; then
          chmod 755 "$PHP_BIN" 2>/dev/null || {
            echo "é”™è¯¯: æ— æ³•è®¾ç½® PHP å¯æ‰§è¡Œæƒé™"
            exit 1
          }
        fi
        
        # æ£€æŸ¥é…ç½®
        if [ ! -f "$SCRIPT_DIR/php.ini" ]; then
          echo "è­¦å‘Š: æœªæ‰¾åˆ° php.ini é…ç½®æ–‡ä»¶"
          CONFIG_OPT=""
        else
          CONFIG_OPT="-c $SCRIPT_DIR/php.ini"
        fi
        
        # æ‰§è¡Œ PHP
        if [ $# -eq 0 ]; then
          # äº¤äº’æ¨¡å¼
          exec "$PHP_BIN" $CONFIG_OPT -a
        else
          # è„šæœ¬æ¨¡å¼
          exec "$PHP_BIN" $CONFIG_OPT "$@"
        fi
        EOF
        
        chmod +x "$DIST_DIR/php-wrapper"
        chmod +x "$DIST_DIR/php"
        
        # åˆ›å»ºç¤ºä¾‹è„šæœ¬
        cat > "$DIST_DIR/example.php" << 'EOF'
        <?php
        echo "=== PHP for Android æµ‹è¯•è„šæœ¬ ===\n\n";
        
        echo "1. åŸºæœ¬ä¿¡æ¯:\n";
        echo "PHP ç‰ˆæœ¬: " . PHP_VERSION . "\n";
        echo "è¿è¡Œå¹³å°: " . PHP_OS . "\n";
        echo "Zend å¼•æ“Ž: " . zend_version() . "\n\n";
        
        echo "2. å·²åŠ è½½æ‰©å±•:\n";
        $extensions = get_loaded_extensions();
        sort($extensions);
        echo implode(", ", $extensions) . "\n\n";
        
        echo "3. åŠŸèƒ½æµ‹è¯•:\n";
        
        // æµ‹è¯•åŠ å¯†åŠŸèƒ½
        if (extension_loaded('openssl')) {
            echo "- OpenSSL: å¯ç”¨\n";
        }
        
        // æµ‹è¯•æ•°æ®åº“åŠŸèƒ½
        if (extension_loaded('pdo_sqlite')) {
            echo "- SQLite3: å¯ç”¨\n";
        }
        
        // æµ‹è¯•åŽ‹ç¼©åŠŸèƒ½
        if (extension_loaded('zlib')) {
            echo "- Zlib: å¯ç”¨\n";
        }
        
        // æµ‹è¯•å›¾åƒå¤„ç†
        if (extension_loaded('gd')) {
            echo "- GD: å¯ç”¨\n";
        }
        
        // æµ‹è¯•å¤šè¯­è¨€
        if (extension_loaded('intl')) {
            echo "- Intl: å¯ç”¨\n";
        }
        
        echo "\n4. æ€§èƒ½æµ‹è¯•:\n";
        $start = microtime(true);
        for ($i = 0; $i < 1000000; $i++) {
            // ç®€å•å¾ªçŽ¯
        }
        echo "100ä¸‡æ¬¡å¾ªçŽ¯è€—æ—¶: " . round((microtime(true) - $start) * 1000, 2) . "ms\n";
        
        echo "\n5. å†…å­˜ä½¿ç”¨:\n";
        echo "å½“å‰å†…å­˜: " . round(memory_get_usage() / 1024, 2) . "KB\n";
        echo "å³°å€¼å†…å­˜: " . round(memory_get_peak_usage() / 1024, 2) . "KB\n";
        
        echo "\n=== æµ‹è¯•å®Œæˆ ===\n";
        ?>
        EOF
        
        # åˆ›å»º README
        cat > "$DIST_DIR/README.md" << EOF
        # PHP for Android - å®Œæ•´åŠŸèƒ½ç‰ˆ
        
        ## æž¶æž„: $ARCH
        - PHP ç‰ˆæœ¬: ${{ env.PHP_VERSION }}
        - Android API: ${{ env.API_LEVEL }}
        - æž„å»ºæ—¶é—´: $(date)
        
        ## åŒ…å«çš„ä¸»è¦åŠŸèƒ½:
        
        ### æ ¸å¿ƒæ‰©å±•
        - **åŠ å¯†**: openssl, sodium, hash, mhash
        - **æ•°æ®åº“**: PDO (SQLite, MySQL, PostgreSQL), mysqli, sqlite3
        - **åŽ‹ç¼©**: zlib, bz2, zip
        - **å›¾åƒå¤„ç†**: GD (PNG, JPEG, WebP, FreeType)
        - **XML**: DOM, SimpleXML, XMLReader, XMLWriter, XSL, XML-RPC
        - **ç½‘ç»œ**: curl, sockets, ftp, soap
        - **å›½é™…åŒ–å’Œç¼–ç **: intl, iconv, mbstring
        - **æ•°å­¦**: bcmath, gmp
        - **è¿›ç¨‹æŽ§åˆ¶**: pcntl, posix
        - **ç³»ç»Ÿ**: shmop, sysvmsg, sysvsem, sysvshm
        - **å…¶ä»–**: json, phar, calendar, exif, filter, tokenizer
        
        ### é«˜çº§åŠŸèƒ½
        - Opcache (å­—èŠ‚ç ç¼“å­˜)
        - FFI (å¤–éƒ¨å‡½æ•°æŽ¥å£)
        - Tidy (HTML æ¸…ç†)
        - Enchant (æ‹¼å†™æ£€æŸ¥)
        - PSpell
        - LDAP
        - SNMP
        
        ## ä½¿ç”¨æ–¹æ³•:
        
        ### 1. å¿«é€Ÿå¼€å§‹
        \`\`\`bash
        # å¤åˆ¶åˆ°è®¾å¤‡
        adb push $ARCH /data/local/tmp/php
        
        # è¿›å…¥è®¾å¤‡ shell
        adb shell
        
        # è¿è¡Œ PHP
        cd /data/local/tmp/php
        ./php-wrapper -v
        ./php-wrapper example.php
        \`\`\`
        
        ### 2. ä½œä¸ºè„šæœ¬è§£é‡Šå™¨
        \`\`\`bash
        # åœ¨è„šæœ¬ç¬¬ä¸€è¡Œæ·»åŠ :
        #!/data/local/tmp/php/php-wrapper
        <?php
        echo "Hello Android PHP!";
        ?>
        \`\`\`
        
        ### 3. äº¤äº’æ¨¡å¼
        \`\`\`bash
        ./php-wrapper
        # è¿›å…¥äº¤äº’å¼ PHP shell
        \`\`\`
        
        ## é…ç½®æ–‡ä»¶:
        - \`php.ini\`: ä¸»é…ç½®æ–‡ä»¶
        - å¯ä»¥ä¿®æ”¹é…ç½®ä»¥é€‚åº”å…·ä½“éœ€æ±‚
        
        ## æ³¨æ„äº‹é¡¹:
        1. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦è®¾ç½®æƒé™: \`chmod +x php-wrapper php\`
        2. å»ºè®®åœ¨ /data/local/tmp ç›®å½•è¿è¡Œï¼Œæœ‰å†™å…¥æƒé™
        3. éƒ¨åˆ†åŠŸèƒ½å¯èƒ½éœ€è¦é¢å¤–çš„ç³»ç»Ÿåº“æ”¯æŒ
        
        ## æ–‡ä»¶å¤§å°è¯´æ˜Ž:
        è™½ç„¶åŒ…å«å¤§é‡åŠŸèƒ½ï¼Œä½†é€šè¿‡ä»¥ä¸‹ä¼˜åŒ–:
        - é™æ€é“¾æŽ¥æ‰€æœ‰ä¾èµ–
        - ç§»é™¤è°ƒè¯•ç¬¦å·
        - LTO (é“¾æŽ¥æ—¶ä¼˜åŒ–)
        - UPX åŽ‹ç¼©
        
        æœ€ç»ˆäºŒè¿›åˆ¶æ–‡ä»¶å¤§å°æŽ§åˆ¶åœ¨åˆç†èŒƒå›´å†…ã€‚
        
        ## æŠ€æœ¯æ”¯æŒ:
        å¦‚æœ‰é—®é¢˜ï¼Œè¯·æäº¤ Issue åˆ°é¡¹ç›®ä»“åº“ã€‚
        EOF
        
        # æ‰“åŒ…
        cd "$DIST_DIR"
        tar -czf "$GITHUB_WORKSPACE/php-android-$ARCH-full.tar.gz" .
        
        echo "åˆ†å‘åŒ…åˆ›å»ºå®Œæˆ: php-android-$ARCH-full.tar.gz"
        echo "åŒ…å«æ–‡ä»¶:"
        ls -la

    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: php-android-${{ matrix.arch }}-full
        path: |
          ${{ github.workspace }}/dist/${{ matrix.arch }}/*
          ${{ github.workspace }}/php-android-${{ matrix.arch }}-full.tar.gz
        retention-days: 30
        compression-level: 9

    - name: åˆ›å»ºå‘å¸ƒ
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ github.workspace }}/php-android-*-full.tar.gz
        body: |
          # PHP for Android - å®Œæ•´åŠŸèƒ½ç‰ˆ
          
          é™æ€é“¾æŽ¥çš„å®Œæ•´åŠŸèƒ½ PHP CLI for Androidï¼Œä»…å…³é—­ Android å¹³å°ä¸æ”¯æŒçš„æ¨¡å—ã€‚
          
          ## ä¸»è¦ç‰¹ç‚¹:
          
          ### ðŸ“¦ å®Œæ•´çš„åŠŸèƒ½é›†
          - **40+ æ‰©å±•**: åŒ…æ‹¬ OpenSSLã€SQLite3ã€GDã€cURLã€Intl ç­‰
          - **æ•°æ®åº“æ”¯æŒ**: PDO (SQLite/MySQL/PostgreSQL)ã€MySQLi
          - **å›¾åƒå¤„ç†**: GD with PNG/JPEG/WebP/FreeType
          - **XML å…¨å®¶æ¡¶**: DOM, SimpleXML, XSL, XML-RPC
          - **ç½‘ç»œåŠŸèƒ½**: cURL, Sockets, FTP, SOAP
          - **åŠ å¯†**: OpenSSL, Sodium, Argon2
          - **å›½é™…åŒ–**: Intl, iconv, mbstring
          
          ### ðŸš€ æ€§èƒ½ä¼˜åŒ–
          - å®Œå…¨é™æ€é“¾æŽ¥ï¼Œé›¶å¤–éƒ¨ä¾èµ–
          - LTO (é“¾æŽ¥æ—¶ä¼˜åŒ–)
          - Opcache å­—èŠ‚ç ç¼“å­˜
          - UPX åŽ‹ç¼©
          - ç§»é™¤æ‰€æœ‰è°ƒè¯•ç¬¦å·
          
          ### ðŸ“± Android ä¸“ä¼˜
          - æ”¯æŒ Android 7.0+ (API 24+)
          - è‡ªé€‚åº” ARM64/ARMv7/x86_64
          - å®Œæ•´çš„å¯åŠ¨è„šæœ¬
          - é¢„é…ç½®çš„ php.ini
          
          ## æ”¯æŒçš„æž¶æž„:
          | æž¶æž„ | è®¾å¤‡ç±»åž‹ | æ–‡ä»¶å¤§å° |
          |------|----------|----------|
          | arm64-v8a | çŽ°ä»£ Android è®¾å¤‡ | ~8-12MB |
          | armeabi-v7a | æ—§æ¬¾ ARM è®¾å¤‡ | ~7-11MB |
          | x86_64 | æ¨¡æ‹Ÿå™¨/Intel è®¾å¤‡ | ~9-13MB |
          
          ## å¿«é€Ÿå¼€å§‹:
          ```bash
          # è§£åŽ‹å¯¹åº”æž¶æž„çš„åŒ…
          tar -xzf php-android-arm64-v8a-full.tar.gz
          
          # æŽ¨é€åˆ° Android è®¾å¤‡
          adb push arm64-v8a /data/local/tmp/php
          
          # è¿è¡Œæµ‹è¯•
          adb shell
          cd /data/local/tmp/php
          ./php-wrapper -v
          ./php-wrapper example.php
          ```
          
          ## åŒ…å«çš„æ‰©å±•:
          ```
          bcmath, bz2, calendar, Core, ctype, curl, date, dom, exif,
          ffi, fileinfo, filter, ftp, gd, gettext, gmp, hash, iconv,
          intl, json, libxml, mbstring, mysqli, mysqlnd, openssl,
          pcntl, pcre, pdo, pdo_mysql, pdo_pgsql, pdo_sqlite, pgsql,
          phar, posix, readline, Reflection, session, shmop, SimpleXML,
          soap, sockets, sodium, SPL, sqlite3, standard, tidy,
          tokenizer, xml, xmlreader, xmlrpc, xmlwriter, xsl, zip, zlib
          ```
          
          ## æ³¨æ„äº‹é¡¹:
          1. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦: `chmod +x php-wrapper php`
          2. å»ºè®®åœ¨ `/data/local/tmp` ç›®å½•è¿è¡Œ
          3. é…ç½®æ–‡ä»¶ `php.ini` å¯è‡ªå®šä¹‰ä¿®æ”¹
          4. åŒ…å«å®Œæ•´çš„ç¤ºä¾‹å’Œæ–‡æ¡£
          
          ## å¼€å‘ç”¨é€”:
          - Android ä¸Šçš„ PHP è„šæœ¬è¿è¡Œ
          - ç§»åŠ¨ç«¯ Web æœåŠ¡æµ‹è¯•
          - PHP å­¦ä¹ å’Œæ•™å­¦
          - æœåŠ¡å™¨è„šæœ¬çš„æœ¬åœ°æµ‹è¯•
          - CI/CD è‡ªåŠ¨åŒ–è„šæœ¬

  summary:
    needs: build
    runs-on: ubuntu-22.04
    steps:
    - name: ä¸‹è½½æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
      run: |
        echo "# PHP for Android å®Œæ•´åŠŸèƒ½ç‰ˆæž„å»ºæŠ¥å‘Š" > BUILD_REPORT.md
        echo "" >> BUILD_REPORT.md
        echo "## æž„å»ºè¯¦æƒ…" >> BUILD_REPORT.md
        echo "- **æž„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> BUILD_REPORT.md
        echo "- **PHP ç‰ˆæœ¬**: ${{ env.PHP_VERSION }}" >> BUILD_REPORT.md
        echo "- **NDK ç‰ˆæœ¬**: ${{ env.NDK_VERSION }}" >> BUILD_REPORT.md
        echo "- **Android API**: ${{ env.API_LEVEL || '24' }}" >> BUILD_REPORT.md
        echo "- **GitHub Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> BUILD_REPORT.md
        echo "" >> BUILD_REPORT.md
        
        echo "## åŒ…å«çš„æ‰©å±•æ¨¡å—" >> BUILD_REPORT.md
        echo "" >> BUILD_REPORT.md
        cat >> BUILD_REPORT.md << 'EOF'
        ### ðŸ›¡ åŠ å¯†å’Œå®‰å…¨
        - openssl: TLS/SSL åŠ å¯†
        - sodium: çŽ°ä»£åŠ å¯†åº“
        - hash: å“ˆå¸Œå‡½æ•°
        - mhash: æ¶ˆæ¯å“ˆå¸Œ
        
        ### ðŸ—„ æ•°æ®åº“æ”¯æŒ
        - PDO: æ•°æ®åº“æŠ½è±¡å±‚
        - pdo_sqlite: SQLite3 é©±åŠ¨
        - pdo_mysql: MySQL é©±åŠ¨
        - pdo_pgsql: PostgreSQL é©±åŠ¨
        - mysqli: MySQL æ”¹è¿›æ‰©å±•
        - sqlite3: SQLite3 æ•°æ®åº“
        - pgsql: PostgreSQL å®¢æˆ·ç«¯
        
        ### ðŸ–¼ å›¾åƒå¤„ç†
        - GD: å›¾åƒç”Ÿæˆå’Œå¤„ç†
        - æ”¯æŒæ ¼å¼: PNG, JPEG, WebP, GIF
        - FreeType: å­—ä½“æ¸²æŸ“
        
        ### ðŸŒ ç½‘ç»œåŠŸèƒ½
        - curl: HTTP å®¢æˆ·ç«¯
        - sockets: ç½‘ç»œå¥—æŽ¥å­—
        - ftp: FTP å®¢æˆ·ç«¯
        - soap: SOAP åè®®
        - xmlrpc: XML-RPC åè®®
        
        ### ðŸ“„ XML å¤„ç†
        - dom: DOM æ–‡æ¡£å¯¹è±¡æ¨¡åž‹
        - SimpleXML: ç®€å• XML è§£æž
        - xmlreader: XML æµè¯»å–å™¨
        - xmlwriter: XML å†™å…¥å™¨
        - xsl: XSLT è½¬æ¢
        
        ### ðŸŒ å›½é™…åŒ–
        - intl: å›½é™…åŒ–å‡½æ•°
        - iconv: å­—ç¬¦é›†è½¬æ¢
        - mbstring: å¤šå­—èŠ‚å­—ç¬¦ä¸²
        
        ### ðŸ”¢ æ•°å­¦è®¡ç®—
        - bcmath: ä»»æ„ç²¾åº¦æ•°å­¦
        - gmp: GNU å¤šç²¾åº¦ç®—æœ¯
        
        ### âš™ ç³»ç»ŸåŠŸèƒ½
        - pcntl: è¿›ç¨‹æŽ§åˆ¶
        - posix: POSIX å‡½æ•°
        - shmop: å…±äº«å†…å­˜
        - sysvmsg: System V æ¶ˆæ¯é˜Ÿåˆ—
        - sysvsem: System V ä¿¡å·é‡
        - sysvshm: System V å…±äº«å†…å­˜
        
        ### ðŸ“¦ åŽ‹ç¼©å’Œå½’æ¡£
        - zlib: Gzip åŽ‹ç¼©
        - bz2: Bzip2 åŽ‹ç¼©
        - zip: ZIP å½’æ¡£
        
        ### ðŸ“ æ–‡æœ¬å¤„ç†
        - tidy: HTML æ¸…ç†
        - enchant: æ‹¼å†™æ£€æŸ¥
        - pspell: æ‹¼å†™æ£€æŸ¥
        - gettext: å›½é™…åŒ–ç¿»è¯‘
        
        ### ðŸ”Œ å…¶ä»–é‡è¦æ‰©å±•
        - ffi: å¤–éƒ¨å‡½æ•°æŽ¥å£
        - exif: å›¾åƒ EXIF æ•°æ®
        - calendar: æ—¥åŽ†è½¬æ¢
        - filter: æ•°æ®è¿‡æ»¤
        - tokenizer: PHP è¯æ³•åˆ†æžå™¨
        - phar: PHP å½’æ¡£
        EOF
        
        echo "" >> BUILD_REPORT.md
        echo "## æ–‡ä»¶æ¸…å•" >> BUILD_REPORT.md
        echo "" >> BUILD_REPORT.md
        find artifacts -name "*.tar.gz" -type f | while read file; do
          echo "- $(basename "$file")" >> BUILD_REPORT.md
          echo "  - å¤§å°: $(du -h "$file" | cut -f1)" >> BUILD_REPORT.md
          echo "  - æž¶æž„: $(basename "$(dirname "$(dirname "$file")")")" >> BUILD_REPORT.md
        done
        
        echo "" >> BUILD_REPORT.md
        echo "## æµ‹è¯•æ–¹æ³•" >> BUILD_REPORT.md
        cat >> BUILD_REPORT.md << 'EOF'
        
        ### åŸºæœ¬æµ‹è¯•
        ```bash
        # æ£€æŸ¥ç‰ˆæœ¬
        ./php-wrapper -v
        
        # æŸ¥çœ‹æ‰€æœ‰æ‰©å±•
        ./php-wrapper -m
        
        # è¿è¡Œç¤ºä¾‹
        ./php-wrapper example.php
        ```
        
        ### åŠŸèƒ½éªŒè¯
        ```bash
        # æµ‹è¯•æ•°æ®åº“
        ./php-wrapper -r "echo extension_loaded('pdo_sqlite') ? 'OK' : 'FAIL';"
        
        # æµ‹è¯•åŠ å¯†
        ./php-wrapper -r "echo extension_loaded('openssl') ? 'OK' : 'FAIL';"
        
        # æµ‹è¯•å›¾åƒå¤„ç†
        ./php-wrapper -r "echo extension_loaded('gd') ? 'OK' : 'FAIL';"
        ```
        
        ### æ€§èƒ½æµ‹è¯•
        ```bash
        # ç®€å•æ€§èƒ½æµ‹è¯•
        ./php-wrapper -r '$start=microtime(true);for($i=0;$i<1000000;$i++){};echo round((microtime(true)-$start)*1000,2)."ms";'
        ```
        EOF
        
        echo "" >> BUILD_REPORT.md
        echo "## å·²çŸ¥é—®é¢˜" >> BUILD_REPORT.md
        echo "" >> BUILD_REPORT.md
        echo "1. **å†…å­˜å ç”¨**: ç”±äºŽåŒ…å«å¤§é‡åŠŸèƒ½ï¼Œå†…å­˜å ç”¨è¾ƒåŸºç¡€ç‰ˆç•¥é«˜" >> BUILD_REPORT.md
        echo "2. **å¯åŠ¨æ—¶é—´**: é¦–æ¬¡å¯åŠ¨éœ€è¦åŠ è½½è¾ƒå¤šæ‰©å±•ï¼Œç¨æ…¢äºŽç²¾ç®€ç‰ˆ" >> BUILD_REPORT.md
        echo "3. **å…¼å®¹æ€§**: æžå°‘æ•° Android 4.x è®¾å¤‡å¯èƒ½ä¸å…¼å®¹" >> BUILD_REPORT.md
        echo "4. **æƒé™è¦æ±‚**: éœ€è¦è®¾å¤‡æœ‰è¶³å¤Ÿçš„ /data/local/tmp å†™å…¥æƒé™" >> BUILD_REPORT.md
        echo "" >> BUILD_REPORT.md
        echo "## ä¼˜åŒ–å»ºè®®" >> BUILD_REPORT.md
        echo "" >> BUILD_REPORT.md
        echo "1. å¦‚ä¸éœ€è¦æ‰€æœ‰åŠŸèƒ½ï¼Œå¯è‡ªè¡Œä¿®æ”¹ php.ini ç¦ç”¨éƒ¨åˆ†æ‰©å±•" >> BUILD_REPORT.md
        echo "2. åœ¨ Android 10+ ä¸Šï¼Œå»ºè®®ä½¿ç”¨ Termux çŽ¯å¢ƒèŽ·å¾—æ›´å¥½å…¼å®¹æ€§" >> BUILD_REPORT.md
        echo "3. å¯¹äºŽèµ„æºå—é™è®¾å¤‡ï¼Œå¯è€ƒè™‘ä½¿ç”¨ç²¾ç®€ç‰ˆæœ¬" >> BUILD_REPORT.md

    - name: ä¸Šä¼ æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: build-report-full
        path: |
          BUILD_REPORT.md
        retention-days: 90
